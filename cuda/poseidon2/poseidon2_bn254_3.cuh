#pragma once

#include "../fields/kb31_t.cuh"
#include "../fields/bn254_t.cuh"

namespace poseidon2_bn254_3 {

namespace constants {

constexpr const int DIGEST_WIDTH = 1;
constexpr const int RATE = 2;
constexpr const int WIDTH = 3;
constexpr const int ROUNDS_P = 56;
constexpr const int ROUNDS_F = 8;
constexpr const int D = 5;


__constant__ constexpr const bn254_t MAT_INTERNAL_DIAG_M1[WIDTH] = {
    bn254_t(
        1342177275,
        2895524892,
        2673921321,
        922515093,
        2021213742,
        1718526831,
        2584207151,
        235567041),
    bn254_t(
        1342177275,
        2895524892,
        2673921321,
        922515093,
        2021213742,
        1718526831,
        2584207151,
        235567041),
    bn254_t(
        2684354550,
        1496082488,
        1052875347,
        1845030187,
        4042427484,
        3437053662,
        873447006,
        471134083)};

__constant__ constexpr const bn254_t INTERNAL_ROUND_CONSTANTS[ROUNDS_P] = {
    bn254_t(
        734045647,
        1646975650,
        997109642,
        3519404116,
        3505792087,
        856637130,
        359522640,
        268947455),
    bn254_t(
        1369678106,
        2144172667,
        1678081141,
        4092591261,
        318819085,
        3163180739,
        2110445992,
        808595279),
    bn254_t(
        582042069,
        1197264998,
        673734574,
        1566890191,
        1294486037,
        1846108158,
        2605502914,
        641934172),
    bn254_t(
        2719144693,
        2081096537,
        1525763933,
        3613055501,
        102687319,
        2754893352,
        1317726070,
        397920440),
    bn254_t(
        1948989170,
        2550945969,
        3756069448,
        2774921930,
        130220684,
        1743731690,
        45480730,
        740827977),
    bn254_t(
        755591862,
        3185645676,
        4025065731,
        3782226546,
        3128980145,
        3161405700,
        2750423884,
        691021944),
    bn254_t(
        3021115033,
        1055373943,
        3332937206,
        3306947477,
        1616690840,
        3435108082,
        1554231242,
        505602676),
    bn254_t(
        478369377,
        490395241,
        2719984492,
        4217345442,
        3878456782,
        3244661104,
        2486620080,
        693400658),
    bn254_t(
        1475690611,
        590515010,
        2331566713,
        542003048,
        3893768059,
        2841034607,
        3765130586,
        794630110),
    bn254_t(
        1243032841,
        1245370996,
        3193624468,
        206601353,
        3365680428,
        2088733653,
        523007556,
        488994468),
    bn254_t(
        49197608,
        2614568931,
        2334040562,
        3748492924,
        4114810834,
        3390312832,
        594324792,
        621134038),
    bn254_t(
        2504824774,
        2984315233,
        3556376306,
        1011811970,
        1895861296,
        209769167,
        94473677,
        236284191),
    bn254_t(
        1667209554,
        4026429117,
        3882294419,
        3948526673,
        3797142494,
        2520846933,
        939403209,
        314753161),
    bn254_t(
        974329796,
        3094661441,
        823306663,
        383972403,
        2486656522,
        3339068031,
        4000836913,
        391387891),
    bn254_t(
        2520877487,
        478509267,
        3543155703,
        2516980093,
        1466582623,
        1194466727,
        90519113,
        488775374),
    bn254_t(
        1967417246,
        1340609107,
        2678785629,
        583170041,
        58403417,
        1436295063,
        3058441710,
        221470092),
    bn254_t(
        293022416,
        4238822009,
        451418692,
        2006247947,
        1552158939,
        2241443360,
        83735784,
        346668057),
    bn254_t(
        1167349959,
        667383285,
        3947077382,
        2200490688,
        1933672662,
        1080508173,
        3911735737,
        354906389),
    bn254_t(
        2821776331,
        2944801524,
        1715292739,
        2645312456,
        379358637,
        1719477132,
        964741263,
        533935593),
    bn254_t(
        3669944254,
        1993176146,
        3007777863,
        396334697,
        2118011961,
        2730279802,
        2920130639,
        12859635),
    bn254_t(
        1703502968,
        2917066622,
        289564987,
        4150591959,
        2348869962,
        2730289752,
        220197909,
        24259170),
    bn254_t(
        2619598112,
        1390491162,
        2373046817,
        1302445093,
        1809121823,
        1211307578,
        2156811440,
        72678744),
    bn254_t(
        2941292631,
        2739858584,
        1459371270,
        772038628,
        291029664,
        2428191016,
        641012309,
        260895836),
    bn254_t(
        836551108,
        607323825,
        137893257,
        3514663581,
        3776215438,
        3771011781,
        280338355,
        4008149),
    bn254_t(
        1331971323,
        632773667,
        4209357613,
        3946134609,
        4059105623,
        16450109,
        2843302513,
        791089602),
    bn254_t(
        1990443836,
        4293136381,
        1349212870,
        2417637127,
        2984544323,
        2924935071,
        3061514866,
        314631564),
    bn254_t(
        1458651181,
        1661540387,
        2262125877,
        3019463588,
        2776988442,
        1512954741,
        3426850729,
        687774099),
    bn254_t(
        2750854576,
        2965655796,
        1786930386,
        4214382716,
        2003385561,
        3478074312,
        350692278,
        378070296),
    bn254_t(
        63282659,
        2329260713,
        1282783213,
        2099237045,
        326196917,
        2068473658,
        3383478767,
        324723585),
    bn254_t(
        2280137240,
        2556294109,
        477850364,
        2324664488,
        1500028379,
        1314076141,
        4021844151,
        223805727),
    bn254_t(
        4282763059,
        3171439128,
        4273724940,
        3293578918,
        3498145257,
        1306053635,
        1482570358,
        21536725),
    bn254_t(
        3266179300,
        3264800718,
        2530533546,
        2951865820,
        3979759827,
        4161996330,
        1257652760,
        336921158),
    bn254_t(
        2531968120,
        706895675,
        278971016,
        3804521335,
        2943364749,
        860502194,
        3799002688,
        126680900),
    bn254_t(
        3973124498,
        370001080,
        2941781072,
        3218367493,
        3780594386,
        3361332948,
        3686658318,
        237301902),
    bn254_t(
        3132436413,
        2447741192,
        3965888550,
        2454957981,
        3501821688,
        2123656068,
        3001320426,
        800815898),
    bn254_t(
        2213388345,
        2895303594,
        2384168621,
        2758347017,
        1002495258,
        1342010416,
        1674094835,
        37529748),
    bn254_t(
        3968642048,
        1070728700,
        3861615193,
        1320597408,
        299630729,
        2049633013,
        2431007532,
        205253635),
    bn254_t(
        3297317085,
        2945683700,
        2821883883,
        1566085317,
        2142262769,
        1925757198,
        770350178,
        406978371),
    bn254_t(
        1505692597,
        1778034462,
        2157836345,
        1539371673,
        1816563228,
        655235633,
        3591664662,
        698421826),
    bn254_t(
        3059735624,
        2305996389,
        1323112863,
        1553749753,
        113869742,
        1985331211,
        508674849,
        185547443),
    bn254_t(
        1180092211,
        2690705953,
        4244387601,
        1040444150,
        1989040718,
        310635861,
        2067715899,
        491914876),
    bn254_t(
        407057572,
        3555100871,
        2336492942,
        855698986,
        3945839642,
        164322475,
        1802021065,
        280258707),
    bn254_t(
        1494861389,
        3641034404,
        2716645661,
        1120049504,
        77868830,
        3675608634,
        3539948990,
        573416767),
    bn254_t(
        3136914794,
        2035687911,
        1245132671,
        3171347127,
        1210972855,
        3599917748,
        2483067111,
        104032114),
    bn254_t(
        196887370,
        2975150812,
        3247525737,
        2472461410,
        1616898121,
        3529764296,
        3704526119,
        538581797),
    bn254_t(
        2100808789,
        2140287963,
        1067575243,
        971149459,
        3409287018,
        1266632127,
        2213594503,
        157221631),
    bn254_t(
        970147016,
        4109068904,
        3426781321,
        1641223999,
        1967899783,
        898308965,
        4174389466,
        68830936),
    bn254_t(
        4004075217,
        1989498960,
        1065150760,
        849065411,
        2334242946,
        3097213960,
        3690304277,
        495190221),
    bn254_t(
        1678277936,
        3887046989,
        1377802086,
        2115837701,
        70645442,
        3665331914,
        210780173,
        371213206),
    bn254_t(
        788353948,
        604383103,
        3212883438,
        1981400066,
        2984258352,
        2381941029,
        1334552723,
        699047552),
    bn254_t(
        1306140209,
        1633910374,
        669728541,
        1159491159,
        1013696572,
        866206507,
        147908431,
        314682364),
    bn254_t(
        4132926429,
        3423011855,
        204391236,
        1275392313,
        3390997795,
        3890811622,
        396803635,
        227454973),
    bn254_t(
        2678048537,
        3733020842,
        713621705,
        2026130867,
        894426391,
        1621583075,
        614996306,
        471871869),
    bn254_t(
        1245245992,
        665013831,
        1226015127,
        3693051804,
        265052259,
        1785939238,
        2357122258,
        265406002),
    bn254_t(
        2436559942,
        438526799,
        1878066002,
        144479130,
        38842622,
        2074637546,
        1319427658,
        136010186),
    bn254_t(
        2632580931,
        4119803722,
        2594903421,
        4277449246,
        1392684775,
        1823673224,
        3381727490,
        627596081)};

__constant__ constexpr const bn254_t EXTERNAL_ROUND_CONSTANTS[ROUNDS_F * WIDTH] = {
    bn254_t(
        3457435724,
        3609376212,
        4096906079,
        687730766,
        3634956745,
        183764678,
        3526684576,
        760503208),
    bn254_t(
        881481092,
        1436722684,
        702829157,
        3611089241,
        2200344084,
        1726505412,
        2998170592,
        68052855),
    bn254_t(
        4160883498,
        176361153,
        2570083988,
        2174199032,
        2059682447,
        1009674563,
        797201192,
        401403632),
    bn254_t(
        3380440970,
        2770157147,
        3694628335,
        89128486,
        2327747735,
        3628338415,
        1398949334,
        6077255),
    bn254_t(
        3764273581,
        70048688,
        2248443155,
        3267086291,
        1956532739,
        609361781,
        246703736,
        724909069),
    bn254_t(
        1881642496,
        1160644771,
        4079350892,
        2322776216,
        3114931302,
        1817226856,
        1506374500,
        75826245),
    bn254_t(
        3794132855,
        181745341,
        457501282,
        1635927723,
        3604520799,
        2660417393,
        1899297791,
        339489468),
    bn254_t(
        2950065113,
        3095753978,
        4264369284,
        10420096,
        1158499066,
        3639024347,
        1452232791,
        786048441),
    bn254_t(
        611312798,
        628250978,
        220906455,
        3986650474,
        1254730724,
        988005075,
        3770071180,
        26267061),
    bn254_t(
        1358774246,
        3886926231,
        2482780435,
        3074925942,
        85764486,
        614080067,
        3527038491,
        319286062),
    bn254_t(
        4153751251,
        2517996319,
        2056404019,
        609377428,
        4070084597,
        1182457876,
        1656311849,
        738344775),
    bn254_t(
        3888457952,
        2463646710,
        3881101127,
        214280462,
        4116681270,
        421405106,
        3560120139,
        687421177),
    bn254_t(
        2926883668,
        2391651036,
        914526665,
        416623884,
        1101744904,
        1590044466,
        160345043,
        310701407),
    bn254_t(
        4234622176,
        532574366,
        817661973,
        2225351062,
        2967651118,
        2616582485,
        4082152431,
        149033412),
    bn254_t(
        3083432730,
        2485387168,
        3939691411,
        2801991852,
        1104292932,
        354821431,
        37688032,
        799970541),
    bn254_t(
        1696094898,
        1264580098,
        228152291,
        3198291519,
        575180996,
        234667919,
        163639293,
        347918150),
    bn254_t(
        765649971,
        3838489697,
        2832616673,
        299913847,
        3354227038,
        3150621051,
        1540005825,
        248499346),
    bn254_t(
        1888753985,
        3753415955,
        3457584097,
        2516599523,
        1823202235,
        1834226525,
        3831801498,
        35762539),
    bn254_t(
        547419785,
        957927179,
        1646982875,
        3973108104,
        2317804102,
        1310414668,
        2698443353,
        763755493),
    bn254_t(
        3317042566,
        264710552,
        2413570641,
        710103378,
        1319883314,
        2061419051,
        4044466518,
        168317790),
    bn254_t(
        3393792888,
        233953762,
        2832833236,
        1241635715,
        3421583421,
        3945515892,
        1266298897,
        781812866),
    bn254_t(
        3255516244,
        645711782,
        3504537034,
        1637536224,
        3488193954,
        2523462724,
        963363189,
        368664792),
    bn254_t(
        4172350922,
        401111680,
        4196418282,
        1718503897,
        1194640023,
        3288543477,
        1160044764,
        711290349),
    bn254_t(
        1067993341,
        445268458,
        1118742954,
        1757420327,
        100117677,
        3321829284,
        657582378,
        93532044)};

__constant__ constexpr const bn254_t MONTY_INVERSE = bn254_t(
    1342177275,
    2895524892,
    2673921321,
    922515093,
    2021213742,
    1718526831,
    2584207151,
    235567041);

} // namespace constants

class Bn254 {
  public:
    using F_t = bn254_t;
    using pF_t = const F_t;

    static constexpr const int DIGEST_WIDTH = constants::DIGEST_WIDTH;
    static constexpr const int RATE = constants::RATE;
    static constexpr const int WIDTH = constants::WIDTH;
    static constexpr const int ROUNDS_F = constants::ROUNDS_F;
    static constexpr const int ROUNDS_P = constants::ROUNDS_P;
    static constexpr const int D = constants::D;

    static constexpr pF_t* INTERNAL_ROUND_CONSTANTS = constants::INTERNAL_ROUND_CONSTANTS;
    static constexpr pF_t* EXTERNAL_ROUND_CONSTANTS = constants::EXTERNAL_ROUND_CONSTANTS;
    static constexpr pF_t* MAT_INTERNAL_DIAG_M1 = constants::MAT_INTERNAL_DIAG_M1;
    static constexpr pF_t MONTY_INVERSE = constants::MONTY_INVERSE;

    __device__ static void internalLinearLayer(F_t state[WIDTH], pF_t*, F_t _) {
        F_t s = state[0] + state[1] + state[2];
        for (int i = 0; i < WIDTH; i++) {
            state[i] *= MAT_INTERNAL_DIAG_M1[i];
            state[i] += s;
        }
    }

    __device__ static void externalLinearLayer(F_t state[WIDTH]) {
        F_t sum = state[0] + state[1] + state[2];
        state[0] += sum;
        state[1] += sum;
        state[2] += sum;
    }
};

static __device__ __constant__ __align__(16) const uint32_t ALT_BN128_1ls31[8] = {
    /* (1<<31) % P_bn254 */
    0x8adc5ced,
    0x49f3c432,
    0x582f50aa,
    0x8b6f9213,
    0x98155c1c,
    0x0938dba1,
    0x76361137,
    0x035e01bf,
};

template <int SIZE>
__device__ void mul_u32_p(uint32_t v, const uint32_t p[SIZE], uint32_t result[SIZE + 1]) {
    uint64_t carry = 0;
    for (int ii = 0; ii < SIZE; ++ii) {
        uint64_t temp = (uint64_t)(v)*p[ii] + carry;
        result[ii] = temp & 0xFFFFFFFF;
        carry = temp >> 32;
    }
    result[SIZE] = (uint32_t)carry;
}

template <int SIZE>
__device__ void substract(uint32_t* a, const uint32_t* b) {
    uint64_t borrow = 0;
    for (int ii = 0; ii < SIZE; ++ii) {
        uint64_t sub = (uint64_t)a[ii] - b[ii] - borrow;
        a[ii] = (uint32_t)(sub & 0xFFFFFFFF);
        borrow = (sub >> 32) & 1;
    }
}

template <int SIZE>
__device__ bool greaterThan(const uint32_t* a, uint32_t* b) {
    for (int i = SIZE - 1; i >= 0; --i) {
        if (a[i] > b[i]) {
            return true;
        }
        if (a[i] < b[i]) {
            return false;
        }
    }
    return false;
}

template <int SIZE>
__device__ void
modulo_p(uint32_t v[SIZE + 1], const uint32_t p[SIZE], uint32_t left, uint32_t rigth) {
    uint32_t prod[SIZE + 1] = {0};
    while (left <= rigth) {
        uint32_t mid = left + (rigth - left) / 2;
        mul_u32_p<SIZE>(mid, p, prod);
        if (greaterThan<SIZE + 1>(prod, v)) {
            rigth = mid - 1;
        } else {
            if (left == mid)
                break;
            left = mid;
        }
    }
    substract<SIZE + 1>(v, prod);
}

const size_t N = 8;

__device__ inline bn254_t kb31_to_bn254(kb31_t in) {
    // The hard-coded constant is the inverse of 1<<32 mod p.
    uint32_t canonical = (0x3f010000ULL * in.val) % (uint64_t)kb31_t::MOD;
    uint32_t v[N + 1] = {0};
    mul_u32_p<N>(canonical, device::ALT_BN128_rone, v);
    // NOTE: likely not the optimal modulo implementation
    // Max 31 large (8 uint32) multiplications
    modulo_p<N>(v, device::ALT_BN128_r, 0x00000000u, kb31_t::MOD);
    return bn254_t(v);
}

__device__ inline bn254_t
reduceKoalaBear(kb31_t* src1, kb31_t* src2, int n1, int n2, int stride1 = 1, int stride2 = 1) {
    const bn254_t po2 = bn254_t(ALT_BN128_1ls31);
    bn254_t res;
    res.set_to_zero();
    if (n2 > 0) {
        for (int ii = (n2 - 1) * stride2; ii >= 0; ii -= stride2) {
            res = res * po2 + kb31_to_bn254(src2[ii]);
        }
    }
    if (n1 > 0) {
        for (int ii = (n1 - 1) * stride1; ii >= 0; ii -= stride1) {
            res = res * po2 + kb31_to_bn254(src1[ii]);
        }
    }
    return res;
}

template <typename Hasher_t, typename HasherState_t>
__device__ void absorbRow(
    Hasher_t hasher,
    kb31_t* in,
    int rowIdx,
    size_t width,
    size_t height,
    HasherState_t* state) {
    kb31_t* rowPtr;
    size_t stride;

    rowPtr = &in[rowIdx];
    stride = height;

    int colIdx = 0;

    if (state->overhangSize > 0) {
        if (state->overhangSize + width < N) {
            // Overhang + row is smaller than N, copy row into overhang and return
            for (size_t i = 0; i < width; i++) {
                state->overhang[state->overhangSize + i] = rowPtr[i * stride];
            }
            state->overhangSize += width;
            return;
        } else {
            // Overhang + row is larger or equal to N, create bn254_t value from overhang and row
            // and continue
            colIdx = N - state->overhangSize;
            bn254_t value =
                reduceKoalaBear(state->overhang, rowPtr, state->overhangSize, colIdx, 1, stride);
            state->overhangSize = 0;
            (*state).absorb(hasher, &value, 1);
        }
    }

    while (colIdx + N <= width) {
        bn254_t value = reduceKoalaBear(rowPtr + colIdx * stride, nullptr, N, 0, stride, 0);
        (*state).absorb(hasher, &value, 1);
        colIdx += N;
    }

    if (colIdx < width) {
        // Copy remaining elements into overhang
        for (size_t i = 0; i < width - colIdx; i++) {
            state->overhang[state->overhangSize + i] = rowPtr[(colIdx + i) * stride];
        }
        state->overhangSize = width - colIdx;
    }
}

} // namespace poseidon2_bn254_3